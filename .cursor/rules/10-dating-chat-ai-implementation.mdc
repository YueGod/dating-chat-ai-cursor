---
description: 
globs: 
alwaysApply: true
---
# DatingèŠå¤©AIæŠ€æœ¯å®ç°æ–¹æ¡ˆ

## ç³»ç»Ÿæ¶æ„

DatingèŠå¤©AIç³»ç»Ÿé‡‡ç”¨åˆ†å±‚æ¶æ„ï¼Œå„æ¨¡å—ç‹¬ç«‹ä¸”ååŒå·¥ä½œï¼Œæ”¯æŒçµæ´»æ‰©å±•å’Œè°ƒæ•´ã€‚

### æ ¸å¿ƒæ¨¡å—ç»“æ„

```
com.dating.ai.chat
â”œâ”€â”€ controller      # APIå…¥å£ç‚¹
â”œâ”€â”€ service         # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ analyzer    # ç”¨æˆ·è¾“å…¥åˆ†æ
â”‚   â”œâ”€â”€ emotion     # æƒ…ç»ªè¯„ä¼°
â”‚   â”œâ”€â”€ strategy    # å¯¹è¯ç­–ç•¥
â”‚   â”œâ”€â”€ generator   # å›å¤ç”Ÿæˆ
â”‚   â””â”€â”€ memory      # å¯¹è¯è®°å¿†
â”œâ”€â”€ model           # æ•°æ®æ¨¡å‹
â”œâ”€â”€ config          # é…ç½®
â”œâ”€â”€ util            # å·¥å…·ç±»
â””â”€â”€ client          # å¤–éƒ¨AIæœåŠ¡å®¢æˆ·ç«¯
```

### å…³é”®ç»„ä»¶èŒè´£

| ç»„ä»¶ | èŒè´£ | å…³é”®ç±» |
|------|------|--------|
| è¾“å…¥åˆ†æå™¨ | è§£æç”¨æˆ·è¾“å…¥ï¼Œæå–æ„å›¾å’Œå®ä½“ | `InputAnalyzer`, `TopicExtractor` |
| æƒ…ç»ªè¯„ä¼°å™¨ | è¯„ä¼°ç”¨æˆ·æƒ…ç»ªçŠ¶æ€å’ŒèŠå¤©æ„æ„¿ | `EmotionScorer`, `EmotionModel` |
| ç­–ç•¥å¼•æ“ | æ ¹æ®æƒ…ç»ªå’Œå†å²ç¡®å®šå›å¤ç­–ç•¥ | `ResponseStrategy`, `TopicManager` |
| å†…å®¹ç”Ÿæˆå™¨ | æ ¹æ®ç­–ç•¥ç”Ÿæˆè‡ªç„¶è¯­è¨€å›å¤ | `ResponseGenerator`, `TemplateEngine` |
| å¯¹è¯è®°å¿† | ç®¡ç†å¯¹è¯å†å²å’Œç”¨æˆ·åå¥½ | `ConversationMemory`, `UserProfile` |

## å¤šæç¤ºè¯å·¥ç¨‹å®ç°

### æç¤ºè¯å¤„ç†ç®¡é“

```java
@Service
public class PromptEngineeringService {
    
    @Autowired
    private EmotionAnalysisService emotionService;
    
    @Autowired
    private ResponseStrategyService strategyService;
    
    @Autowired
    private ContentGenerationService generationService;
    
    @Autowired
    private ConversationMemoryService memoryService;
    
    public ChatResponse processUserInput(String userId, String userInput) {
        // 1. è·å–å¯¹è¯å†å²
        ConversationContext context = memoryService.getConversationContext(userId);
        
        // 2. æƒ…ç»ªåˆ†æ
        EmotionAnalysisResult emotionResult = emotionService.analyzeEmotion(
            userInput, context);
        
        // 3. ç¡®å®šå›å¤ç­–ç•¥
        ResponseStrategy strategy = strategyService.determineStrategy(
            emotionResult, context);
        
        // 4. ç”Ÿæˆå›å¤å†…å®¹
        String response = generationService.generateResponse(
            userInput, emotionResult, strategy, context);
        
        // 5. æ›´æ–°å¯¹è¯å†å²
        memoryService.updateConversation(userId, userInput, response, 
            emotionResult, strategy);
        
        return new ChatResponse(response, emotionResult.getScore());
    }
}
```

### æƒ…ç»ªè¯„åˆ†ç³»ç»Ÿ

```java
@Service
public class EmotionAnalysisService {
    
    @Autowired
    private EmotionAnalysisClient aiClient;
    
    @Autowired
    private EmotionDictionaryService dictionaryService;
    
    public EmotionAnalysisResult analyzeEmotion(String userInput, 
                                               ConversationContext context) {
        // æ„å»ºæç¤ºè¯
        String prompt = buildEmotionAnalysisPrompt(userInput, context);
        
        // è°ƒç”¨AIæœåŠ¡è¿›è¡Œæƒ…ç»ªåˆ†æ
        String aiResponse = aiClient.getCompletion(prompt);
        
        // è§£æAIå“åº”
        EmotionAnalysisResult result = parseEmotionAnalysisResponse(aiResponse);
        
        // åº”ç”¨è§„åˆ™ä¿®æ­£
        applyEmotionCorrectionRules(result, context);
        
        return result;
    }
    
    private String buildEmotionAnalysisPrompt(String userInput, 
                                             ConversationContext context) {
        StringBuilder prompt = new StringBuilder();
        prompt.append("åˆ†æä»¥ä¸‹ç”¨æˆ·è¾“å…¥çš„æƒ…ç»ªçŠ¶æ€ï¼Œæ ¹æ®æƒ…æ„Ÿè¯æ±‡(40%)ã€")
              .append("å¥æ³•ç»“æ„(20%)ã€ååº”é€Ÿåº¦(15%)ã€")
              .append("å¯¹è¯è¿è´¯æ€§(15%)å’Œç¬¦å·ä½¿ç”¨(10%)äº”ä¸ªç»´åº¦è¯„åˆ†(0-100)ï¼š\n\n");
        
        prompt.append("ç”¨æˆ·è¾“å…¥: \"").append(userInput).append("\"\n");
        prompt.append("å¯¹è¯å†å²: ").append(formatConversationHistory(context)).append("\n");
        prompt.append("ä¸Šæ¬¡å“åº”æ—¶é—´: ").append(context.getLastResponseTime()).append("\n");
        prompt.append("å½“å‰æ—¶é—´: ").append(System.currentTimeMillis()).append("\n\n");
        
        prompt.append("è¾“å‡ºæ ¼å¼ï¼šJSONå¯¹è±¡ï¼ŒåŒ…å«æ€»åˆ†å’Œå„ç»´åº¦åˆ†æ•°");
        
        return prompt.toString();
    }
    
    private EmotionAnalysisResult parseEmotionAnalysisResponse(String aiResponse) {
        try {
            // è§£æJSONå“åº”
            JsonNode node = objectMapper.readTree(aiResponse);
            
            // æå–æ€»åˆ†å’Œå„ç»´åº¦åˆ†æ•°
            int totalScore = node.get("totalScore").asInt();
            int sentimentScore = node.get("sentimentScore").asInt();
            int syntaxScore = node.get("syntaxScore").asInt();
            int responseTimeScore = node.get("responseTimeScore").asInt();
            int coherenceScore = node.get("coherenceScore").asInt();
            int symbolScore = node.get("symbolScore").asInt();
            
            return new EmotionAnalysisResult(totalScore, sentimentScore, 
                syntaxScore, responseTimeScore, coherenceScore, symbolScore);
        } catch (Exception e) {
            log.error("è§£ææƒ…ç»ªåˆ†æå“åº”å¤±è´¥", e);
            // è¿”å›é»˜è®¤å€¼
            return new EmotionAnalysisResult(50, 50, 50, 50, 50, 50);
        }
    }
}
```

## å¯¹è¯ç­–ç•¥ç¡®å®š

### ç­–ç•¥é€‰æ‹©æœåŠ¡

```java
@Service
public class ResponseStrategyService {
    
    public ResponseStrategy determineStrategy(EmotionAnalysisResult emotion, 
                                             ConversationContext context) {
        ResponseStrategy strategy = new ResponseStrategy();
        
        // æ ¹æ®æƒ…ç»ªåˆ†æ•°é€‰æ‹©åŸºç¡€ç­–ç•¥ç±»å‹
        if (emotion.getTotalScore() >= 80) {
            strategy.setType(StrategyType.HIGH_ENGAGEMENT);
        } else if (emotion.getTotalScore() >= 60) {
            strategy.setType(StrategyType.MEDIUM_HIGH_ENGAGEMENT);
        } else if (emotion.getTotalScore() >= 40) {
            strategy.setType(StrategyType.MEDIUM_ENGAGEMENT);
        } else if (emotion.getTotalScore() >= 20) {
            strategy.setType(StrategyType.LOW_ENGAGEMENT);
        } else {
            strategy.setType(StrategyType.VERY_LOW_ENGAGEMENT);
        }
        
        // ç¡®å®šæ˜¯å¦éœ€è¦è¯é¢˜åˆ‡æ¢
        boolean needTopicSwitch = determineTopicSwitchNeed(
            emotion, context);
        strategy.setNeedTopicSwitch(needTopicSwitch);
        
        // å¦‚æœéœ€è¦åˆ‡æ¢è¯é¢˜ï¼Œé€‰æ‹©æ–°è¯é¢˜
        if (needTopicSwitch) {
            String newTopic = selectNewTopic(context, emotion.getTotalScore());
            strategy.setTargetTopic(newTopic);
        }
        
        // é€‰æ‹©ä¸ªæ€§åŒ–å…ƒç´ 
        List<PersonalizationElement> elements = selectPersonalizationElements(
            emotion, context);
        strategy.setPersonalizationElements(elements);
        
        return strategy;
    }
    
    private boolean determineTopicSwitchNeed(EmotionAnalysisResult emotion, 
                                           ConversationContext context) {
        // å½“å‰è¯é¢˜å·²æŒç»­å¤šè½®
        boolean longTopic = context.getCurrentTopicTurns() >= 3;
        
        // æƒ…ç»ªåˆ†æ•°æ˜¾è‘—ä¸‹é™
        boolean emotionDrop = context.getEmotionHistory().size() > 0 && 
            (context.getLastEmotionScore() - emotion.getTotalScore() > 15);
        
        // å›å¤é•¿åº¦æ˜¾è‘—å‡å°‘
        boolean responseLengthDrop = isResponseLengthSignificantlyReduced(context);
        
        // æ£€æµ‹åˆ°ç»“æŸè¯
        boolean endingTokenDetected = containsEndingTokens(
            context.getLastUserMessage());
        
        return longTopic || emotionDrop || responseLengthDrop || endingTokenDetected;
    }
    
    private String selectNewTopic(ConversationContext context, int emotionScore) {
        // ä»ç”¨æˆ·å…´è¶£ä¸­é€‰æ‹©æ–°è¯é¢˜
        List<String> userInterests = context.getUserProfile().getInterests();
        
        // è¯é¢˜åˆ‡æ¢é£æ ¼ä¾èµ–äºæƒ…ç»ªåˆ†æ•°
        TopicTransitionStyle style;
        if (emotionScore >= 60) {
            style = TopicTransitionStyle.GRADUAL;
        } else if (emotionScore >= 40) {
            style = TopicTransitionStyle.BRIDGING;
        } else {
            style = TopicTransitionStyle.DIRECT;
        }
        
        // TODO: å®ç°è¯é¢˜é€‰æ‹©é€»è¾‘
        return selectTopicBasedOnStyle(userInterests, style);
    }
}
```

## å›å¤ç”Ÿæˆç³»ç»Ÿ

### å†…å®¹ç”ŸæˆæœåŠ¡

```java
@Service
public class ContentGenerationService {
    
    @Autowired
    private AIGenerationClient aiClient;
    
    @Autowired
    private TemplateRepository templateRepo;
    
    public String generateResponse(String userInput, EmotionAnalysisResult emotion,
                                 ResponseStrategy strategy, ConversationContext context) {
        // æ„å»ºæç¤ºè¯
        String prompt = buildResponseGenerationPrompt(
            userInput, emotion, strategy, context);
        
        // è°ƒç”¨AIæœåŠ¡ç”Ÿæˆå›å¤
        String aiResponse = aiClient.getCompletion(prompt);
        
        // åå¤„ç†å›å¤
        String processedResponse = postProcessResponse(
            aiResponse, strategy, context);
        
        return processedResponse;
    }
    
    private String buildResponseGenerationPrompt(String userInput, EmotionAnalysisResult emotion,
                                               ResponseStrategy strategy, 
                                               ConversationContext context) {
        StringBuilder prompt = new StringBuilder();
        
        // åŸºç¡€æŒ‡ä»¤
        prompt.append("æ ¹æ®ä»¥ä¸‹æƒ…ç»ªåˆ†æç»“æœå’Œå¯¹è¯å†å²ï¼Œç”Ÿæˆè‡ªç„¶ã€ä¸ªæ€§åŒ–çš„å›å¤ï¼š\n\n");
        
        // æƒ…ç»ªåˆ†æç»“æœ
        prompt.append("æƒ…ç»ªåˆ†æ: ").append(formatEmotionResult(emotion)).append("\n\n");
        
        // å¯¹è¯å†å²
        prompt.append("å¯¹è¯å†å²: \n").append(formatConversationHistory(context)).append("\n\n");
        
        // å½“å‰è¯é¢˜
        prompt.append("å½“å‰è¯é¢˜: ").append(context.getCurrentTopic()).append("\n");
        
        // è¯é¢˜åˆ‡æ¢ä¿¡æ¯
        prompt.append("éœ€è¦è¯é¢˜åˆ‡æ¢: ").append(strategy.isNeedTopicSwitch()).append("\n");
        if (strategy.isNeedTopicSwitch()) {
            prompt.append("ç›®æ ‡è¯é¢˜: ").append(strategy.getTargetTopic()).append("\n");
        }
        
        // å›å¤ç­–ç•¥
        prompt.append("å›å¤ç­–ç•¥: ").append(strategy.getType()).append("\n\n");
        
        // ä¸ªæ€§åŒ–å…ƒç´ 
        prompt.append("ä½¿ç”¨ä»¥ä¸‹ä¸ªæ€§åŒ–å…ƒç´ : ").append(
            formatPersonalizationElements(strategy.getPersonalizationElements())).append("\n\n");
        
        // æœ€ç»ˆæŒ‡ä»¤
        prompt.append("å›å¤éœ€è¦:\n");
        prompt.append("1. ç›´æ¥å›åº”ç”¨æˆ·è¾“å…¥\n");
        prompt.append("2. è¡¨è¾¾é€‚å½“æƒ…æ„Ÿ\n");
        prompt.append("3. åŠ å…¥æŒ‡å®šçš„ä¸ªæ€§åŒ–å…ƒç´ \n");
        prompt.append("4. ").append(strategy.isNeedTopicSwitch() ? 
            "è‡ªç„¶è¿‡æ¸¡åˆ°æ–°è¯é¢˜" : "ç»§ç»­å‘å±•å½“å‰è¯é¢˜").append("\n");
        prompt.append("5. åŒ…å«äº’åŠ¨æ€§é—®é¢˜æˆ–é™ˆè¿°\n\n");
        
        prompt.append("ä¿æŒè‡ªç„¶å‹å¥½çš„è¯­æ°”ï¼Œä¸è¦å¤ªè¿‡æ­£å¼ã€‚å›å¤åº”å½“çœ‹èµ·æ¥åƒä¸€ä¸ªçœŸå®çš„äººã€‚");
        
        return prompt.toString();
    }
    
    private String postProcessResponse(String aiResponse, ResponseStrategy strategy,
                                     ConversationContext context) {
        // ç§»é™¤å¯èƒ½çš„å¼•å·å’Œå‰ç¼€
        String processed = aiResponse.replaceAll("^[\"\']", "").replaceAll("[\"\']$", "");
        
        // ç¡®ä¿å›å¤ç¬¦åˆäººè®¾
        processed = ensurePersonaConsistency(processed, context.getUserProfile().getPreferredPersona());
        
        // å¦‚æœå“åº”å¤ªé•¿ï¼Œé€‚å½“ç¼©å‡
        if (processed.length() > getMaxResponseLength(strategy.getType())) {
            processed = truncateResponse(processed, strategy.getType());
        }
        
        return processed;
    }
}
```

## å¯¹è¯è®°å¿†ç³»ç»Ÿ

### è®°å¿†ç®¡ç†

```java
@Service
public class ConversationMemoryService {
    
    @Autowired
    private ConversationRepository conversationRepo;
    
    @Autowired
    private UserProfileRepository userProfileRepo;
    
    public ConversationContext getConversationContext(String userId) {
        // è·å–åŸºæœ¬ç”¨æˆ·èµ„æ–™
        UserProfile profile = userProfileRepo.findByUserId(userId)
            .orElseGet(() -> createDefaultUserProfile(userId));
        
        // è·å–æœ€è¿‘çš„å¯¹è¯å†å²
        List<MessagePair> recentMessages = conversationRepo
            .findRecentMessagesByUserId(userId, 10);
        
        // è·å–æƒ…ç»ªå†å²
        List<EmotionRecord> emotionHistory = conversationRepo
            .findRecentEmotionsByUserId(userId, 5);
        
        // æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡
        ConversationContext context = new ConversationContext();
        context.setUserProfile(profile);
        context.setRecentMessages(recentMessages);
        context.setEmotionHistory(emotionHistory);
        context.setCurrentTopic(determineCurrentTopic(recentMessages));
        context.setCurrentTopicTurns(countTopicTurns(recentMessages, context.getCurrentTopic()));
        context.setLastResponseTime(getLastResponseTime(recentMessages));
        
        return context;
    }
    
    public void updateConversation(String userId, String userInput, String response,
                                 EmotionAnalysisResult emotion, ResponseStrategy strategy) {
        // åˆ›å»ºæ–°çš„æ¶ˆæ¯å¯¹
        MessagePair messagePair = new MessagePair();
        messagePair.setUserId(userId);
        messagePair.setUserMessage(userInput);
        messagePair.setAiResponse(response);
        messagePair.setTimestamp(System.currentTimeMillis());
        messagePair.setEmotionScore(emotion.getTotalScore());
        messagePair.setTopic(strategy.isNeedTopicSwitch() ? 
            strategy.getTargetTopic() : determineCurrentTopic(userInput, strategy));
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        conversationRepo.save(messagePair);
        
        // æ›´æ–°æƒ…ç»ªè®°å½•
        EmotionRecord emotionRecord = new EmotionRecord();
        emotionRecord.setUserId(userId);
        emotionRecord.setTimestamp(System.currentTimeMillis());
        emotionRecord.setTotalScore(emotion.getTotalScore());
        emotionRecord.setSentimentScore(emotion.getSentimentScore());
        emotionRecord.setSyntaxScore(emotion.getSyntaxScore());
        emotionRecord.setResponseTimeScore(emotion.getResponseTimeScore());
        emotionRecord.setCoherenceScore(emotion.getCoherenceScore());
        emotionRecord.setSymbolScore(emotion.getSymbolScore());
        
        // ä¿å­˜æƒ…ç»ªè®°å½•
        conversationRepo.saveEmotionRecord(emotionRecord);
        
        // æ›´æ–°ç”¨æˆ·å…´è¶£å’Œåå¥½
        updateUserProfileFromInteraction(userId, userInput, response, emotion);
    }
    
    private void updateUserProfileFromInteraction(String userId, String userInput,
                                               String response, EmotionAnalysisResult emotion) {
        // æå–å¯èƒ½çš„å…´è¶£ç‚¹
        List<String> potentialInterests = extractPotentialInterests(userInput);
        
        // åªæœ‰å½“æƒ…ç»ªåˆ†æ•°è¾ƒé«˜æ—¶ï¼Œæ‰è®¤ä¸ºè¿™æ˜¯çœŸå®å…´è¶£
        if (emotion.getTotalScore() >= 60 && !potentialInterests.isEmpty()) {
            UserProfile profile = userProfileRepo.findByUserId(userId)
                .orElseGet(() -> createDefaultUserProfile(userId));
            
            // æ›´æ–°å…´è¶£
            for (String interest : potentialInterests) {
                if (!profile.getInterests().contains(interest)) {
                    profile.getInterests().add(interest);
                }
            }
            
            // ä¿å­˜æ›´æ–°åçš„èµ„æ–™
            userProfileRepo.save(profile);
        }
    }
}
```

## æ•°æ®æ¨¡å‹

### æ ¸å¿ƒå®ä½“ç±»å®šä¹‰

```java
@Data
public class EmotionAnalysisResult {
    private int totalScore; // æ€»æƒ…ç»ªåˆ† (0-100)
    private int sentimentScore; // æƒ…æ„Ÿè¯æ±‡åˆ† (0-100)
    private int syntaxScore; // å¥æ³•ç»“æ„åˆ† (0-100)
    private int responseTimeScore; // å“åº”æ—¶é—´åˆ† (0-100)
    private int coherenceScore; // å¯¹è¯è¿è´¯æ€§åˆ† (0-100)
    private int symbolScore; // ç¬¦å·ä½¿ç”¨åˆ† (0-100)
    
    // æ ¹æ®åˆ†æ•°ç¡®å®šæƒ…ç»ªçŠ¶æ€
    public EmotionState getEmotionalState() {
        if (totalScore >= 80) return EmotionState.EXCITED;
        if (totalScore >= 60) return EmotionState.INTERESTED;
        if (totalScore >= 40) return EmotionState.NEUTRAL;
        if (totalScore >= 20) return EmotionState.TIRED;
        return EmotionState.NEGATIVE;
    }
}

@Data
public class ResponseStrategy {
    private StrategyType type;
    private boolean needTopicSwitch;
    private String targetTopic;
    private List<PersonalizationElement> personalizationElements;
    
    // è·å–é€‚åˆå½“å‰ç­–ç•¥çš„æ¨¡æ¿
    public List<String> getSuitableTemplates() {
        switch (type) {
            case HIGH_ENGAGEMENT:
                return Arrays.asList(
                    "æˆ‘çœŸçš„å¾ˆå–œæ¬¢ä½ è¯´çš„å…³äº{topic}çš„çœ‹æ³•ï¼{å…±é¸£ç‚¹}ã€‚æˆ‘æ›¾ç»ä¹Ÿ{ç›¸å…³ç»å†}ï¼Œè®©æˆ‘{æƒ…æ„Ÿååº”}ã€‚ä½ å¹³æ—¶è¿˜ä¼š{ç›¸å…³é—®é¢˜}å—ï¼Ÿ",
                    // æ›´å¤šæ¨¡æ¿...
                );
            case MEDIUM_HIGH_ENGAGEMENT:
                // è¿”å›ä¸­é«˜äº’åŠ¨æ¨¡æ¿
            case MEDIUM_ENGAGEMENT:
                // è¿”å›ä¸­ç­‰äº’åŠ¨æ¨¡æ¿
            case LOW_ENGAGEMENT:
                // è¿”å›ä½äº’åŠ¨æ¨¡æ¿
            case VERY_LOW_ENGAGEMENT:
                // è¿”å›æä½äº’åŠ¨æ¨¡æ¿
            default:
                return Collections.emptyList();
        }
    }
}

@Data
public class ConversationContext {
    private UserProfile userProfile;
    private List<MessagePair> recentMessages;
    private List<EmotionRecord> emotionHistory;
    private String currentTopic;
    private int currentTopicTurns;
    private long lastResponseTime;
    
    // è·å–ä¸Šæ¬¡æƒ…ç»ªåˆ†æ•°
    public int getLastEmotionScore() {
        if (emotionHistory != null && !emotionHistory.isEmpty()) {
            return emotionHistory.get(0).getTotalScore();
        }
        return 50; // é»˜è®¤ä¸­ç­‰
    }
    
    // è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
    public String getLastUserMessage() {
        if (recentMessages != null && !recentMessages.isEmpty()) {
            return recentMessages.get(0).getUserMessage();
        }
        return "";
    }
}

@Data
public class UserProfile {
    private String userId;
    private List<String> interests;
    private Map<String, Integer> topicPreferences; // è¯é¢˜åŠå…¶å…´è¶£åº¦
    private PersonaType preferredPersona;
    private int avgResponseLength; // ç”¨æˆ·å¹³å‡å›å¤é•¿åº¦
    private int avgEmotionScore; // ç”¨æˆ·å¹³å‡æƒ…ç»ªåˆ†æ•°
}
```

## é›†æˆä¸æµ‹è¯•

### å•å…ƒæµ‹è¯•ç¤ºä¾‹

```java
@SpringBootTest
public class EmotionAnalysisServiceTest {
    
    @MockBean
    private EmotionAnalysisClient aiClient;
    
    @Autowired
    private EmotionAnalysisService emotionService;
    
    @Test
    public void testHighEmotionScoring() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String userInput = "å“‡ï¼æˆ‘ä»Šå¤©ç‰¹åˆ«å¼€å¿ƒï¼åˆšå¾—åˆ°äº†ç†æƒ³å…¬å¸çš„offerï¼ğŸ˜„ğŸ˜„";
        ConversationContext context = new ConversationContext();
        // è®¾ç½®ä¸Šä¸‹æ–‡...
        
        // Mock AIå®¢æˆ·ç«¯å“åº”
        String mockResponse = "{\"totalScore\": 90, \"sentimentScore\": 95, " +
            "\"syntaxScore\": 85, \"responseTimeScore\": 80, " +
            "\"coherenceScore\": 85, \"symbolScore\": 100}";
        when(aiClient.getCompletion(anyString())).thenReturn(mockResponse);
        
        // æ‰§è¡Œæµ‹è¯•
        EmotionAnalysisResult result = emotionService.analyzeEmotion(userInput, context);
        
        // éªŒè¯ç»“æœ
        assertEquals(90, result.getTotalScore());
        assertEquals(EmotionState.EXCITED, result.getEmotionalState());
    }
    
    @Test
    public void testLowEmotionScoring() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        String userInput = "å—¯ï¼Œå¥½çš„ã€‚";
        ConversationContext context = new ConversationContext();
        // è®¾ç½®ä¸Šä¸‹æ–‡...
        
        // Mock AIå®¢æˆ·ç«¯å“åº”
        String mockResponse = "{\"totalScore\": 25, \"sentimentScore\": 30, " +
            "\"syntaxScore\": 20, \"responseTimeScore\": 30, " +
            "\"coherenceScore\": 20, \"symbolScore\": 10}";
        when(aiClient.getCompletion(anyString())).thenReturn(mockResponse);
        
        // æ‰§è¡Œæµ‹è¯•
        EmotionAnalysisResult result = emotionService.analyzeEmotion(userInput, context);
        
        // éªŒè¯ç»“æœ
        assertEquals(25, result.getTotalScore());
        assertEquals(EmotionState.TIRED, result.getEmotionalState());
    }
}
```

### APIæ¥å£ç¤ºä¾‹

```java
@RestController
@RequestMapping("/api/chat")
@Api(tags = "èŠå¤©API")
public class ChatController {
    
    @Autowired
    private PromptEngineeringService promptService;
    
    @PostMapping("/{userId}")
    @ApiOperation("å¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶è¿”å›AIå›å¤")
    public ResponseEntity<ChatResponse> processMessage(
            @PathVariable String userId,
            @RequestBody MessageRequest request) {
        
        // éªŒè¯è¯·æ±‚
        if (request.getMessage() == null || request.getMessage().trim().isEmpty()) {
            return ResponseEntity.badRequest().build();
        }
        
        // å¤„ç†ç”¨æˆ·è¾“å…¥
        ChatResponse response = promptService.processUserInput(
            userId, request.getMessage());
        
        return ResponseEntity.ok(response);
    }
    
    @GetMapping("/{userId}/history")
    @ApiOperation("è·å–ç”¨æˆ·èŠå¤©å†å²")
    public ResponseEntity<List<MessagePair>> getChatHistory(
            @PathVariable String userId,
            @RequestParam(defaultValue = "10") int limit) {
        
        List<MessagePair> history = promptService.getChatHistory(userId, limit);
        
        return ResponseEntity.ok(history);
    }
}
```

## æ‰©å±•ä¸é…ç½®

### é…ç½®ç®¡ç†

```java
@Configuration
@ConfigurationProperties(prefix = "dating.chat.ai")
@Data
public class ChatAIConfig {
    
    // AIæœåŠ¡é…ç½®
    private String aiServiceUrl;
    private String apiKey;
    private int maxTokens = 300;
    private double temperature = 0.7;
    
    // æƒ…ç»ªè¯„åˆ†é…ç½®
    private Map<String, Double> emotionFactorWeights = Map.of(
        "sentiment", 0.4,
        "syntax", 0.2,
        "responseTime", 0.15,
        "coherence", 0.15,
        "symbol", 0.1
    );
    
    // è¯é¢˜ç®¡ç†é…ç½®
    private int maxTopicTurns = 3;
    private double emotionDropThreshold = 15.0;
    private List<String> topicEndingTokens = Arrays.asList(
        "å—¯", "å“¦", "å¥½çš„", "å¯ä»¥", "è¡Œ", "çŸ¥é“äº†"
    );
    
    // å“åº”ç”Ÿæˆé…ç½®
    private Map<StrategyType, Integer> maxResponseLengthByStrategy = Map.of(
        StrategyType.HIGH_ENGAGEMENT, 150,
        StrategyType.MEDIUM_HIGH_ENGAGEMENT, 120,
        StrategyType.MEDIUM_ENGAGEMENT, 100,
        StrategyType.LOW_ENGAGEMENT, 60,
        StrategyType.VERY_LOW_ENGAGEMENT, 40
    );
    
    // æ¨¡æ¿é…ç½®
    private boolean useTemplates = true;
    private String templateLocation = "classpath:/templates/chat";
}
```

### æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

1. **ç¼“å­˜ç­–ç•¥**
   - å¯¹å¸¸ç”¨çš„AIå“åº”æ¨¡å¼è¿›è¡Œç¼“å­˜
   - ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·ä¼šè¯å’Œæƒ…ç»ªçŠ¶æ€
   - é¢„è®¡ç®—çƒ­é—¨è¯é¢˜çš„æ¨¡æ¿å˜ä½“

2. **å¼‚æ­¥å¤„ç†**
   - ä½¿ç”¨Springçš„å¼‚æ­¥ä»»åŠ¡å¤„ç†æƒ…ç»ªåˆ†æ
   - åå°ä»»åŠ¡ä¼˜åŒ–ç”¨æˆ·å…´è¶£æ¨¡å‹
   - å¹¶è¡Œæ‰§è¡Œå¤šä¸ªAIæœåŠ¡è°ƒç”¨

3. **é™çº§ç­–ç•¥**
   - å½“AIæœåŠ¡ä¸å¯ç”¨æ—¶ä½¿ç”¨é¢„è®¾æ¨¡æ¿
   - åŸºäºè§„åˆ™çš„å¤‡ç”¨æƒ…ç»ªè¯„åˆ†ç³»ç»Ÿ
   - ç®€åŒ–å¤„ç†æµç¨‹çš„è½»é‡çº§æ¨¡å¼
